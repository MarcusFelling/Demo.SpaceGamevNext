name: pipeline
on: [workflow_dispatch, push]
env:
  APPNAME: spacegamevnext # Name of app. Used for prefix in resource group, service plan, app service, container images, sql server and database.
  REGISTRYNAME: "marcusfellingspacegamevnextacr" # Registry that is shared across environments
  LOCATION: "WestUS" # Region for all Azure resources

jobs:

  deploy-test:
    name: Deploy to Test
    runs-on: ubuntu-20.04
    environment:
      name: test
      url: https://${{ env.APPNAME }}-${{ env.ENVIRONMENTNAME }}.azurewebsites.net
    env:
      ENVIRONMENTNAME: test
      DEVENV: false
    needs: [deploy-dev]
    steps:
      - uses: actions/checkout@master

      - name: Azure authentication
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy infrastructure
        run: >
          az deployment sub create \
            --name 'spacegamedeploy-${{ env.ENVIRONMENTNAME }}' \
            --location '${{ env.LOCATION }}' \
            --template-file iac/main.bicep \
            --parameters appName='${{ env.APPNAME }}' \
                         environmentName=${{ env.ENVIRONMENTNAME }} \
                         registryName='${{ env.REGISTRYNAME }}' \
                         tag='${{ github.sha }}' \
                         dbUserName='${{ secrets.DBUSERNAME }}' \
                         dbPassword='${{ secrets.DBPASSWORD }}' \
                         devEnv='${{ env.DEVENV }}'

      - uses: actions/download-artifact@v2
        name: Download dacpac from build
        with:
          name: dacpac

      - name: Deploy Database using dacpac
        uses: docker://markhobson/sqlpackage:latest # Use container with sqlpackage.exe
        with:
          args: /SourceFile:"database.dacpac" /Action:Publish /TargetServerName:"${{ env.APPNAME }}-${{ env.ENVIRONMENTNAME }}-sql.database.windows.net" /TargetDatabaseName:"${{ env.APPNAME }}database" /TargetUser:"${{ secrets.DBUSERNAME }}" /TargetPassword:"${{ secrets.DBPASSWORD }}"

      - name: Get ACR credentials
        id: getACRCred
        run: |
          echo "::set-output name=acr_username::`az acr credential show -n ${{ env.REGISTRYNAME }} --query username | xargs`"
          echo "::set-output name=acr_password::`az acr credential show -n ${{ env.REGISTRYNAME }} --query passwords[0].value | xargs`"
          echo "::add-mask::`az acr credential show -n ${{ env.REGISTRYNAME }} --query passwords[0].value | xargs`"

      - name: "Deploy to Azure Web App for Containers slot"
        uses: azure/webapps-deploy@v2
        with:
          app-name: "${{ env.APPNAME }}-${{ env.ENVIRONMENTNAME }}"
          slot-name: "swap"
          images: ${{ env.REGISTRYNAME }}.azurecr.io/${{ env.APPNAME }}:${{ github.sha }}

      - name: Swap slots for no downtime deploy
        run: |
          az webapp deployment slot swap -g '${{ env.APPNAME }}-${{ env.ENVIRONMENTNAME }}-rg' -n '${{ env.APPNAME }}-${{ env.ENVIRONMENTNAME }}' --slot 'swap' --target-slot 'production'

  test-e2e:
    name: Run E2E Tests
    runs-on: ubuntu-20.04
    container: mcr.microsoft.com/playwright:v1.21.0-focal
    environment:
      name: test
      url: https://${{ env.APPNAME }}-${{ env.ENVIRONMENTNAME }}.azurewebsites.net
    env:
      ENVIRONMENTNAME: test-e2e
      SITE_URL: https://spacegamevnext-test.azurewebsites.net # Playwright tests use this env var
    needs: [deploy-test]
    steps:
      - uses: actions/checkout@master
      - uses: actions/setup-node@v2
        with:
          node-version: "14.x"

      - name: Install dependencies
        run: npm ci

      - name: Run Playwright Tests
        continue-on-error: false
        run: |
          HOME=/root npx playwright test --config e2e-tests/playwright.config.ts

      - name: Create test summary
        uses: test-summary/action@dist
        if: always()
        with:
          paths: e2e-tests/**/*.xml

      - uses: actions/upload-artifact@v2
        name: Upload HTML report
        if: always()
        with:
          name: e2e-tests-report
          path: e2e-tests/test-results/html

  test-load:
    name: Run Load Tests
    runs-on: ubuntu-20.04
    environment:
      name: test-load
      url: https://${{ env.APPNAME }}-${{ env.ENVIRONMENTNAME }}.azurewebsites.net
    env:
      ENVIRONMENTNAME: test
    needs: [deploy-test, test-e2e]
    steps:
      - uses: actions/checkout@master

      - name: Azure authentication
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: "Azure Load Testing - Home Page Test"
        uses: azure/load-testing@v1
        with:
          loadTestConfigFile: "load-tests/home-page.yaml"
          loadTestResource: ${{ env.APPNAME }}-loadtest
          resourceGroup: ${{ env.APPNAME }}-loadtest-rg
          env: |
            [
                {
                "name": "HOMEPAGE_URL",
                "value": "spacegamevnext-test.azurewebsites.net"
                }
            ]

  deploy-prod:
    name: Deploy to Prod
    runs-on: ubuntu-20.04
    environment:
      name: prod
      url: https://${{ env.APPNAME }}-${{ env.ENVIRONMENTNAME }}.azurewebsites.net
    env:
      ENVIRONMENTNAME: prod
      DEVENV: false
    needs: [deploy-test, test-load, test-e2e]
    steps:
      - uses: actions/checkout@master

      - name: Azure authentication
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy infrastructure
        run: >
          az deployment sub create \
            --name 'spacegamedeploy-${{ env.ENVIRONMENTNAME }}' \
            --location '${{ env.LOCATION }}' \
            --template-file iac/main.bicep \
            --parameters appName='${{ env.APPNAME }}' \
                         environmentName=${{ env.ENVIRONMENTNAME }} \
                         registryName='${{ env.REGISTRYNAME }}' \
                         tag='${{ github.sha }}' \
                         dbUserName='${{ secrets.DBUSERNAME }}' \
                         dbPassword='${{ secrets.DBPASSWORD }}' \
                         devEnv='${{ env.DEVENV }}'

      - uses: actions/download-artifact@v2
        name: Download dacpac from build
        with:
          name: dacpac

      - name: Deploy Database using dacpac
        uses: docker://markhobson/sqlpackage:latest # Use container with sqlpackage.exe
        with:
          args: /SourceFile:"database.dacpac" /Action:Publish /TargetServerName:"${{ env.APPNAME }}-${{ env.ENVIRONMENTNAME }}-sql.database.windows.net" /TargetDatabaseName:"${{ env.APPNAME }}database" /TargetUser:"${{ secrets.DBUSERNAME }}" /TargetPassword:"${{ secrets.DBPASSWORD }}"

      - name: Get ACR credentials
        id: getACRCred
        run: |
          echo "::set-output name=acr_username::`az acr credential show -n ${{ env.REGISTRYNAME }} --query username | xargs`"
          echo "::set-output name=acr_password::`az acr credential show -n ${{ env.REGISTRYNAME }} --query passwords[0].value | xargs`"
          echo "::add-mask::`az acr credential show -n ${{ env.REGISTRYNAME }} --query passwords[0].value | xargs`"

      - name: "Deploy to Azure Web App for Containers slot"
        uses: azure/webapps-deploy@v2
        with:
          app-name: "${{ env.APPNAME }}-${{ env.ENVIRONMENTNAME }}"
          slot-name: "swap"
          images: ${{ env.REGISTRYNAME }}.azurecr.io/${{ env.APPNAME }}:${{ github.sha }}

      - name: Swap slots for no downtime deploy
        run: |
          az webapp deployment slot swap -g '${{ env.APPNAME }}-${{ env.ENVIRONMENTNAME }}-rg' -n '${{ env.APPNAME }}-${{ env.ENVIRONMENTNAME }}' --slot 'swap' --target-slot 'production'
