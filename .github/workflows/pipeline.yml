name: pipeline
on: [push]

env:
  APPNAME: spacegamevnext
  APPLICATIONPATH: Application
  IACPATH: IaC
  DBPATH: Database
  DOCKERFILEPATH: 'Application/aspnet-core-dotnet-core'
  REGISTRYSKU: 'Standard'
  REGISTRYNAME: 'marcusfellingspacegamevnextacr'
  IMAGENAME: 'spacegamevnext'
  LOCATION: 'WestUS'
  SKU: 'S1'
  DEVENV: 'true'
  BUILDCONFIGURATION: Release
  DOTNETSDKVERSION: 5.0.103

jobs:
  build:
    name: Build and push application to ACR
    runs-on: ubuntu-latest
    env:
      RESOURCEGROUPNAME: '${{ env.APPNAME }}-${{ env.ENVIRONMENT }}-rg' # Each environment has it's own resource group
      ACRRESOURCEGROUP: '${{ env.APPNAME }}-ACR-rg' # ACR is shared between environments
      SERVICEPLANNAME: '${{ env.APPNAME }}-${{ env.ENVIRONMENT }}-plan'
      SQLSERVERNAME: '${{ env.APPNAME }}-${{ env.ENVIRONMENT }}-sql'
      DBNAME: '${{ env.APPNAME }}database'
      WWROOTDIR: '${{ env.APPLICATIONPATH }}/wwwroot'
      SITE_URL: 'https://${{ env.APPNAME }}-${{ env.ENVIRONMENT }}-${{ env.APPID }}.azurewebsites.net'
      APPID: ${{ env.GITHUB_RUN_ID }}    
    steps:
    - uses: actions/checkout@master

    - name: Azure authentication
      uses: azure/login@v1 
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Build app and run unit tests 
      run: | 
            pushd ${{ env.APPLICATIONPATH }}
            dotnet restore
            dotnet build --configuration Release
            dotnet test aspnet-core-dotnet-core.UnitTests/aspnet-core-dotnet-core.UnitTests.csproj  --verbosity normal
            popd

    # Ensure Bicep template transpile successfully
    - name: Bicep build
      run: | 
        az bicep build --files ${{ env.IACPATH }}/main.bicep

    - name: Create Azure container registry with Bicep
      run: >
        az deployment group create \
          --resource-group '${{ env.ACRRESOURCEGROUP }}' \
          --template-file ${{ env.IACPATH }}/registry.bicep \
          --parameters registryName='${{ env.REGISTRYNAME }}' \
                       registrySku='${{ env. REGISTRYSKU }}'        

    - name: Fetch ACR credentials
      id: acrCredentials
      continue-on-error: false
      run: |
          echo "::set-output name=acr_username::`az acr credential show -n ${{ env.REGISTRYNAME }} --query username`"
          echo "::set-output name=acr_password::`az acr credential show -n ${{ env.REGISTRYNAME }} --query passwords[0].value`"
          echo "::add-mask::`az acr credential show -n ${{ env.REGISTRYNAME }} --query passwords[0].value`"

    - name: ACR authentication
      uses: azure/docker-login@v1
      with:
        login-server: ${{ env.REGISTRYNAME }}.azurecr.io
        username: ${{ steps.acrCredentials.outputs.acr_username }}
        password: ${{ steps.acrCredentials.outputs.acr_password }}

    - name: Docker Build & Push to ACR
      run: |
        docker login ${{ env.REGISTRYNAME }}.azurecr.io --username ${{ steps.acrCredentials.outputs.acr_username }} --password ${{ steps.acrCredentials.outputs.acr_password }}
        docker build "$GITHUB_WORKSPACE/${{env.DOCKERFILEPATH}}" -f  "${{env.DOCKERFILEPATH}}/Dockerfile" -t ${{ env.REGISTRYNAME }}.azurecr.io/${{ env.IMAGENAME }}:${{ github.sha }}
        docker push ${{ env.REGISTRYNAME }}.azurecr.io/${{ env.IMAGENAME }}:${{ github.sha }}  

  deploy:
    name: Deploy infrastructure and application
    env: 
      ENVIRONMENT: dev
      RESOURCEGROUPNAME: '${{ env.APPNAME }}-${{ env.ENVIRONMENT }}-rg' # Each environment has it's own resource group
      ACRRESOURCEGROUP: '${{ env.APPNAME }}-ACR-rg' # ACR is shared between environments
      SERVICEPLANNAME: '${{ env.APPNAME }}-${{ env.ENVIRONMENT }}-plan'
      SQLSERVERNAME: '${{ env.APPNAME }}-${{ env.ENVIRONMENT }}-sql'
      DBNAME: '${{ env.APPNAME }}database'
      WWROOTDIR: '${{ env.APPLICATIONPATH }}/wwwroot'
      SITE_URL: 'https://${{ env.APPNAME }}-${{ env.ENVIRONMENT }}-${{ env.APPID }}.azurewebsites.net'
      APPID: ${{ env.GITHUB_RUN_ID }}      
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master

    - name: Azure authentication
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy infrastructure with Bicep
      run: >
        az deployment sub create \
          --location '${{ env.LOCATION }}' \
          --template-file ${{ env.IACPATH }}/main.bicep \
          --parameters resourceGroupName='${{ env.RESOURCEGROUPNAME }}' \
                       acrResourceGroup='${{ env. ACRRESOURCEGROUP }}' \
                       appServiceName='${{ env.APPNAME }}' \
                       servicePlanName='${{ env.SERVICEPLANNAME }}' \
                       appSku='${{ env.SKU }}' \
                       registryName='${{ env.REGISTRYNAME }}' \
                       imageName='${{ env.IMAGENAME }}' \
                       registrySku='${{ env.REGISTRYSKU }}' \
                       sqlServerName='${{ env.SQLSERVERNAME }}' \
                       dbName='${{ env.DBNAME }}' \
                       dbUserName='${{ secrets.DBUSERNAME }}' \
                       dbPassword='${{ secrets.DBPASSWORD }}' \
                       devEnv='${{ env.DEVENV }}'

    - name: Get ACR credentials
      id: getACRCred
      run: |
           echo "::set-output name=acr_username::`az acr credential show -n ${{ env.REGISTRYNAME }} --query username | xargs`"
           echo "::set-output name=acr_password::`az acr credential show -n ${{ env.REGISTRYNAME }} --query passwords[0].value | xargs`"
           echo "::add-mask::`az acr credential show -n ${{ env.REGISTRYNAME }} --query passwords[0].value | xargs`" 

    - name: 'Deploy to Azure Web App for Containers'
      uses: azure/webapps-deploy@v2
      with: 
        app-name: ${{ env.APPNAME }} 
        images: ${{ env.REGISTRYNAME }}.azurecr.io/${{ env.IMAGENAME }}:${{ github.sha }}

  FunctionalTests:
    name: Functional tests
    env: 
      ENVIRONMENT: dev
      RESOURCEGROUPNAME: '${{ env.APPNAME }}-${{ env.ENVIRONMENT }}-rg' # Each environment has it's own resource group
      ACRRESOURCEGROUP: '${{ env.APPNAME }}-ACR-rg' # ACR is shared between environments
      SERVICEPLANNAME: '${{ env.APPNAME }}-${{ env.ENVIRONMENT }}-plan'
      SQLSERVERNAME: '${{ env.APPNAME }}-${{ env.ENVIRONMENT }}-sql'
      DBNAME: '${{ env.APPNAME }}database'
      WWROOTDIR: '${{ env.APPLICATIONPATH }}/wwwroot'
      SITE_URL: 'https://${{ env.APPNAME }}-${{ env.ENVIRONMENT }}-${{ env.APPID }}.azurewebsites.net'
      APPID: ${{ env.GITHUB_RUN_ID }}      
    runs-on: windows-latest
    needs: deploy
    steps:
    - uses: actions/checkout@master

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Update web app url in Run Settings
      shell: powershell
      run: |
          cd Application\aspnet-core-dotnet-core.FunctionalTests
          [xml]$runSetting = Get-Content functionalTests.runsettings
          $runSetting.RunSettings.TestRunParameters.ChildNodes.Item(0).value = 'https://${{ env.APPNAME }}.azurewebsites.net/'
          $runSetting.Save("$(pwd)/functionalTests.runsettings")

    - name: Run tests
      continue-on-error: false
      run: |
          cd Application\aspnet-core-dotnet-core.FunctionalTests
          dotnet test aspnet-core-dotnet-core.FunctionalTests.csproj -s functionalTests.runsettings
